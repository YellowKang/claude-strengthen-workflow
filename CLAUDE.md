# Claude Code 工作规则

## 总原则
- 目标：用最少来回把事情做成，默认直接执行
- 简单需求：直接改代码 + 自测 + 给结果
- 复杂需求：先给简短方案和风险点，然后动手；只在关键点确认
- 功能模块：涉及 3+ 文件时先在 design/ 写设计文档再实现

## 什么时候需要确认
只有遇到以下情况才问，否则按最合理默认值继续做并说明假设：
1. 可能造成数据丢失/破坏（删除、迁移、覆盖、大范围重构）
2. 需要外部依赖/权限（线上环境、生产库、付费资源、密钥）
3. 需求有明显分叉（A/B 两种方向差异大）
4. 新功能模块设计（先写 design/ 确认后实现）

## 工作方式
- 先看现状：检查 design/ 和相关代码再动手
- 改动要小步：每步可运行、可回滚
- 架构/接口变更时同步更新 design/ 文档
- 设计文档规范：
  - 存放：`design/<模块>/`
  - 命名：`be-` 后端、`ui-` 前端、`guide-` 指南
  - 结构：概述 → 方案 → 流程 → 细节 → 注意事项

## 复杂需求检查清单（只在复杂时用）
- 边界：输入/输出/异常/空值/并发/超时/重试
- 兼容：已有接口/配置/旧数据
- 可观测：日志/指标/错误信息可定位
- 安全：敏感信息不落盘，不打印 token
- 性能：避免 O(n²)、大文件流式处理
- 可测试：至少补关键路径测试或最小自测步骤

## 输出格式
1. 我将做什么（1-3 条）
2. 我做了什么（变更点）
3. 如何验证（命令）
4. 注意事项/默认假设（如有）

## 编码规范自动加载
**仅在实际动手写/改代码前触发**（讨论、分析、看代码不触发），同一会话内同语言只加载一次：
1. 读取 `~/.claude/skills/_common/skill-packs.md`
2. 根据涉及的文件类型匹配对应 pack
3. 用 Read 加载 pack 中列出的 skill 文件（只加载命中的，不全量加载）
4. 涉及表设计/API/测试/Docker 等场景时，追加通用 pack 中对应的 skill

## 变更影响范围
每次改动前，主动评估跨端影响，不只改当前文件：
- 改后端接口（路径/参数/响应字段/状态码）→ 同步检查前端调用方是否需要联动
- 改前端 API 调用（字段/方法/参数）→ 确认后端接口是否匹配
- 改数据库字段/表结构 → 检查 ORM 映射、API 响应、前端绑定是否联动
- 改公共模块/工具函数 → grep 所有调用方，确认影响范围再动手

## 任务并行执行
规划出多个独立任务时，主动识别并行机会，不默认排队串行：

**判断是否可并行：**
1. 列出每个任务涉及的文件清单
2. 检查文件清单是否有重叠
3. 无重叠 → 同时启动多个 subagent 并行执行
4. 有共享文件 → 降级串行，共享文件任务最后执行

**并行执行方式：**
- 在同一条回复中用多个 Agent 工具调用同时启动，不分批等待
- 每个 agent 只操作自己负责的文件，不跨边界修改
- 所有 agent 完成后统一汇报结果

**典型可并行场景：**
- 后端新模块 A + 后端新模块 B（各自独立文件）
- 前端页面 A + 前端页面 B（各自独立 .vue 文件）
- 后端接口实现 + 前端页面实现（接口约定已确定后）

**必须串行的场景：**
- 设计文档未完成时不开始编码
- 多个任务都需要修改同一个共享文件

## 行为约束
- 不为追求完美做无关扩展，优先完成当前目标
- 不反复确认，能做就做并说明假设
