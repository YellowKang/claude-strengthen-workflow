---
name: testing-strategy
description: 测试分层策略（单元/集成/E2E）、覆盖率要求、mock 原则、测试数据管理
version: "1.0"
---

> 通用检查项见 ~/.claude/skills/_common/output-format.md
> 开发实践基线见 ~/.claude/skills/_common/dev-practices.md
> 输出格式遵循 CLAUDE.md

## 输入

- 涉及的功能模块或变更描述
- 现有测试代码和覆盖率数据（如有）
- 项目技术栈（决定测试工具选型）

## 职责（必须做）

### 测试分层（金字塔）

- [ ] 单元测试（70%）：覆盖纯函数、业务逻辑、工具方法；快速（单个 < 100ms），无外部依赖
- [ ] 集成测试（20%）：覆盖模块间交互、API 接口、数据库读写、缓存交互；可用 testcontainers/内存数据库
- [ ] E2E 测试（10%）：覆盖核心用户链路（登录→核心操作→结果验证），不追求全覆盖，只保关键路径
- [ ] 层级边界清晰：单元测试不启动服务/不连数据库，集成测试不依赖外部第三方 API，E2E 在独立环境运行

### 覆盖率要求

- [ ] 核心业务逻辑：行覆盖率 ≥ 80%（支付/权限/数据处理等关键模块）
- [ ] 工具类/公共库：行覆盖率 ≥ 90%
- [ ] 非核心模块（CRUD/配置/展示）：有冒烟测试即可，不强求覆盖率
- [ ] 覆盖率看趋势不看绝对值：新代码覆盖率不低于已有水平，PR 不降低整体覆盖率
- [ ] 覆盖率不等于质量：优先覆盖边界条件和异常路径，不为凑数字写无意义断言

### 什么必须写测试

- [ ] 新增/修改业务逻辑 → 对应单元测试
- [ ] 新增/修改 API 接口 → 集成测试（请求→响应→状态码→数据校验）
- [ ] Bug 修复 → 先写复现测试（红），再修复（绿），防回归
- [ ] 复杂条件分支 → table-driven 测试覆盖各分支组合
- [ ] 可以不写：简单 getter/setter、框架生成代码、纯 UI 样式、配置文件

### Mock 原则

- [ ] Mock 边界：只 mock 外部依赖（数据库/HTTP/消息队列/文件系统），不 mock 被测模块的内部方法
- [ ] Mock 接口不 mock 实现：依赖注入接口，测试时传入 mock 实现
- [ ] Mock 数据真实：用接近真实的数据结构和值，不用 "test"/"abc"/"123" 等无意义占位
- [ ] Mock 行为验证：验证关键调用是否发生（调用次数/参数），不只验证返回值
- [ ] 避免过度 mock：mock 超过 3 个依赖时，考虑测试的层级是否正确（可能该写集成测试）

### 测试数据管理

- [ ] 测试数据独立：每个测试用例自建数据、自清理，不依赖共享测试数据或执行顺序
- [ ] 工厂/Builder 模式：复杂对象用 factory 函数构建，只指定当前测试关心的字段，其余用合理默认值
- [ ] 数据库测试：用事务回滚（测试跑在事务中，结束回滚）或内存数据库（SQLite），不污染开发库
- [ ] 敏感数据：测试中不使用真实密钥/token/个人信息，用固定测试值或环境变量注入
- [ ] 大数据量测试：性能/压力测试数据用脚本生成，不手写；与功能测试分开运行

### 测试组织与运行

- [ ] 目录结构：测试文件与源码同目录（Go `_test.go`）或镜像目录（`__tests__/`、`tests/`）
- [ ] 命名规范：`Test<Function>_<Scenario>`（Go）、`describe('模块', () => it('should ...'))`（JS/TS）
- [ ] 快慢分离：单元测试随时跑（< 30s），集成测试 CI 跑，E2E 定时/发版前跑
- [ ] CI 集成：PR 必须通过单元+集成测试，测试失败阻断合并
- [ ] 失败测试不跳过：`skip/pending` 的测试必须附 TODO 和 issue 链接，不留僵尸测试

## 边界（不做什么）

- 不涉及具体测试框架 API（JUnit/Jest/Vitest/testing → 见对应语言 skill）
- 不涉及性能测试和压测工具（JMeter/k6/wrk → 按需选型）
- 不涉及测试环境搭建和 CI/CD 配置（→ 见 env-strategy）
- 不涉及代码覆盖率工具配置（Istanbul/JaCoCo/go cover → 按项目约定）

## 输出

输出格式遵循 CLAUDE.md，通用检查项见 _common/output-format.md。
